<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Football Transfer Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface2: #21262d;
      --surface3: #2d333b;
      --border: #30363d;
      --accent: #238636;
      --accent-hover: #2ea043;
      --red: #da3633;
      --red-soft: rgba(218,54,51,0.12);
      --green: #3fb950;
      --green-soft: rgba(63,185,80,0.12);
      --yellow: #d29922;
      --blue: #388bfd;
      --text: #e6edf3;
      --muted: #8b949e;
      --radius: 10px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ── Header ── */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-logo {
      width: 28px; height: 28px;
      background: var(--accent);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; flex-shrink: 0;
    }
    header h1 { font-size: 16px; font-weight: 600; letter-spacing: -.01em; }
    .header-badge {
      margin-left: auto;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 12px;
      color: var(--muted);
      display: flex; align-items: center; gap: 6px;
    }
    .header-badge::before {
      content: '';
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--green);
      display: inline-block;
    }

    /* ── Layout ── */
    .container { max-width: 1280px; margin: 0 auto; padding: 36px 32px; }

    /* ── Section heading ── */
    .section-heading {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-heading::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ── Form card ── */
    .form-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px 32px;
      margin-bottom: 36px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    .form-group { display: flex; flex-direction: column; gap: 7px; }
    label { font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .05em; }
    input, select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-size: 14px;
      padding: 9px 12px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
      width: 100%;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(35,134,54,.15);
    }
    select option { background: var(--surface2); }
    .input-hint { font-size: 11px; color: var(--muted); margin-top: 2px; min-height: 16px; }

    .form-actions { margin-top: 24px; display: flex; gap: 14px; align-items: center; }
    #run-btn {
      background: var(--accent);
      border: none;
      border-radius: 7px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      padding: 10px 28px;
      transition: background .15s, transform .1s;
      display: flex; align-items: center; gap: 8px;
      min-width: 160px; justify-content: center;
    }
    #run-btn:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
    #run-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

    /* Spinner */
    .spinner {
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #run-btn.loading .spinner { display: block; }
    #run-btn.loading .btn-text { opacity: .8; }

    #status-msg { font-size: 13px; color: var(--muted); }

    /* ── Error banner ── */
    #error-banner {
      display: none;
      background: #2d1515;
      border: 1px solid var(--red);
      border-left: 4px solid var(--red);
      border-radius: var(--radius);
      color: #ff7b72;
      font-size: 14px;
      padding: 14px 18px;
      margin-bottom: 28px;
    }

    /* ── Results ── */
    #results { display: none; }

    /* ── Headline card ── */
    .headline-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      border-radius: var(--radius);
      padding: 28px 32px;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }
    .headline-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(35,134,54,.06) 0%, rgba(56,139,253,.04) 100%);
      pointer-events: none;
    }
    .headline-meta {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mode-badge {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .04em;
    }
    .mode-badge.balanced { color: var(--blue); border-color: rgba(56,139,253,.3); }
    .mode-badge.conservative { color: var(--green); border-color: rgba(63,185,80,.3); }
    .mode-badge.win_now { color: var(--yellow); border-color: rgba(210,153,34,.3); }
    .headline-text {
      font-size: 17px;
      line-height: 1.65;
      font-weight: 400;
      color: var(--text);
      max-width: 900px;
    }

    /* ── KPI row ── */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 28px;
    }
    .kpi-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 20px;
      transition: border-color .15s;
    }
    .kpi-card:hover { border-color: var(--surface3); }
    .kpi-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .kpi-value { font-size: 24px; font-weight: 700; line-height: 1; margin-bottom: 6px; }
    .kpi-value.positive { color: var(--green); }
    .kpi-value.negative { color: var(--red); }
    .kpi-value.neutral { color: var(--text); }
    .kpi-sub { font-size: 12px; color: var(--muted); }

    /* ── Charts — new layout ── */
    .chart-top {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px 28px;
      margin-bottom: 16px;
    }
    .charts-bottom {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 16px;
      margin-bottom: 28px;
    }
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px 28px 24px 36px;
      overflow: visible;
    }
    .chart-title {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 20px;
      font-weight: 600;
    }
    #chart-age { height: 260px !important; }

    /* ── Analysis row ── */
    .analysis-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .analysis-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px 28px;
    }
    .analysis-card h3 {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 16px;
      font-weight: 600;
    }
    .analysis-card p { font-size: 14px; line-height: 1.7; color: var(--text); }
    .obs-list { list-style: none; display: flex; flex-direction: column; gap: 12px; }
    .obs-list li {
      font-size: 14px;
      line-height: 1.6;
      padding-left: 18px;
      position: relative;
      color: var(--text);
    }
    .obs-list li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 8px;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    /* ── Weakness card ── */
    .weakness-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 4px solid var(--yellow);
      border-radius: var(--radius);
      padding: 20px 24px;
      margin-bottom: 28px;
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }
    .weakness-icon { font-size: 20px; flex-shrink: 0; line-height: 1.4; }
    .weakness-label {
      font-size: 11px;
      color: var(--yellow);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .weakness-text { font-size: 14px; line-height: 1.65; color: var(--text); }

    /* ── Transfer justifications ── */
    .transfers-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px;
    }
    .transfer-col-header {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .transfer-col-header .count-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
    }
    .col-sold .transfer-col-header { color: var(--red); }
    .col-sold .count-badge { background: var(--red-soft); color: var(--red); }
    .col-bought .transfer-col-header { color: var(--green); }
    .col-bought .count-badge { background: var(--green-soft); color: var(--green); }

    .transfer-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: border-color .15s;
    }
    .transfer-item:hover { border-color: var(--surface3); }
    .col-sold .transfer-item { border-left: 3px solid var(--red); }
    .col-bought .transfer-item { border-left: 3px solid var(--green); }

    .t-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; gap: 8px; }
    .t-name { font-size: 14px; font-weight: 600; }
    .t-fee {
      font-size: 12px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .col-sold .t-fee { background: var(--red-soft); color: var(--red); }
    .col-bought .t-fee { background: var(--green-soft); color: var(--green); }
    .t-meta { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .t-reason { font-size: 13px; color: #adbac7; line-height: 1.6; }
  </style>
</head>
<body>

<header>
  <div class="header-logo">⚽</div>
  <h1>Football Transfer Simulator</h1>
  <div class="header-badge">Gemini AI</div>
</header>

<div class="container">

  <!-- Form -->
  <div class="form-card">
    <div class="section-heading">Simulation Parameters</div>
    <form id="sim-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="team_name">Club</label>
          <select id="team_name" name="team_name" required>
            <optgroup label="LaLiga">
              <option value="FC Barcelona" selected>FC Barcelona</option>
              <option value="Real Madrid">Real Madrid</option>
              <option value="Atletico Madrid">Atletico Madrid</option>
              <option value="Real Sociedad">Real Sociedad</option>
              <option value="Villarreal">Villarreal</option>
            </optgroup>
          </select>
          <div class="input-hint">LaLiga — 5 clubs available</div>
        </div>
        <div class="form-group">
          <label for="season">Season</label>
          <select id="season" name="season" required>
            <option value="2025">2025/26 (current)</option>
            <option value="2024" selected>2024/25</option>
            <option value="2023">2023/24</option>
            <option value="2022">2022/23</option>
          </select>
        </div>
        <div class="form-group">
          <label for="transfer_budget">Transfer Budget</label>
          <input id="transfer_budget" name="transfer_budget" type="number" value="100000000" required />
          <div class="input-hint" id="transfer-hint">€100.0M &nbsp;·&nbsp; typical range €50M–€300M</div>
        </div>
        <div class="form-group">
          <label for="salary_budget">Salary Budget (Annual)</label>
          <input id="salary_budget" name="salary_budget" type="number" value="300000000" required />
          <div class="input-hint" id="salary-hint">€300.0M / yr &nbsp;·&nbsp; typical range €200M–€500M</div>
        </div>
        <div class="form-group">
          <label for="strategy_mode">Strategy Mode</label>
          <select id="strategy_mode" name="strategy_mode">
            <option value="balanced">Balanced — Moderate buys/sells, full budget available</option>
            <option value="conservative">Conservative — Buy young, sell older, spend at most 50% of budget</option>
            <option value="win_now">Win Now — Keep experienced players (35+), spend aggressively</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" id="run-btn">
          <div class="spinner"></div>
          <span class="btn-text">Run Simulation</span>
        </button>
        <span id="status-msg"></span>
      </div>
    </form>
  </div>

  <!-- Error -->
  <div id="error-banner"></div>

  <!-- Results -->
  <div id="results">

    <!-- Headline -->
    <div class="headline-card">
      <div class="headline-meta" id="headline-meta"></div>
      <div class="headline-text" id="headline-text"></div>
    </div>

    <!-- KPIs -->
    <div class="section-heading">Key Performance Indicators</div>
    <div class="kpi-row" id="kpi-row"></div>

    <!-- Charts -->
    <div class="section-heading">Visualizations</div>
    <div class="chart-top">
      <div class="chart-title">Squad Age Distribution — Before vs After</div>
      <canvas id="chart-age"></canvas>
    </div>
    <div class="charts-bottom">
      <div class="chart-card">
        <div class="chart-title">Squad Valuation</div>
        <canvas id="chart-val"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Budget Usage</div>
        <div style="margin-bottom: 24px;"><canvas id="chart-budget-transfer"></canvas></div>
        <div><canvas id="chart-budget-salary"></canvas></div>
      </div>
    </div>

    <!-- Observations + Financial -->
    <div class="section-heading">AI Analysis</div>
    <div class="analysis-row" style="margin-bottom: 16px;">
      <div class="analysis-card">
        <h3>Key Observations</h3>
        <ul class="obs-list" id="obs-list"></ul>
      </div>
      <div class="analysis-card">
        <h3>Financial Verdict</h3>
        <p id="financial-verdict"></p>
      </div>
    </div>

    <!-- Weakness -->
    <div class="weakness-card">
      <div class="weakness-icon">⚠️</div>
      <div>
        <div class="weakness-label">Squad Weakness Identified</div>
        <div class="weakness-text" id="weakness-text"></div>
      </div>
    </div>

    <!-- Transfer Justifications -->
    <div class="section-heading">Transfer Justifications</div>
    <div class="transfers-grid">
      <div class="col-sold">
        <div class="transfer-col-header">
          Sold <span class="count-badge" id="sold-count"></span>
        </div>
        <div id="sold-list"></div>
      </div>
      <div class="col-bought">
        <div class="transfer-col-header">
          Bought <span class="count-badge" id="bought-count"></span>
        </div>
        <div id="bought-list"></div>
      </div>
    </div>

  </div><!-- /results -->
</div><!-- /container -->

<script>
  // ── Chart instances ──
  let chartAge = null, chartVal = null, chartBudgetTransfer = null, chartBudgetSalary = null;

  const MODE_LABELS = {
    balanced: 'Balanced',
    conservative: 'Conservative',
    win_now: 'Win Now',
  };

  function fmt(n) {
    if (Math.abs(n) >= 1_000_000) return '€' + (n / 1_000_000).toFixed(1) + 'M';
    if (Math.abs(n) >= 1_000) return '€' + (n / 1_000).toFixed(0) + 'K';
    return '€' + n;
  }

  function fmtBudgetHint(val, suffix) {
    if (!val || isNaN(val)) return '';
    if (val >= 1_000_000) return '€' + (val / 1_000_000).toFixed(1) + 'M' + (suffix || '');
    if (val >= 1_000) return '€' + (val / 1_000).toFixed(0) + 'K' + (suffix || '');
    return '€' + val;
  }

  // Live budget hints
  document.getElementById('transfer_budget').addEventListener('input', e => {
    document.getElementById('transfer-hint').innerHTML = fmtBudgetHint(+e.target.value, '') + ' &nbsp;·&nbsp; typical range €50M–€300M';
  });
  document.getElementById('salary_budget').addEventListener('input', e => {
    document.getElementById('salary-hint').innerHTML = fmtBudgetHint(+e.target.value, ' / yr') + ' &nbsp;·&nbsp; typical range €200M–€500M';
  });

  function renderKPIs(kpis, sold_count, bought_count) {
    const row = document.getElementById('kpi-row');
    const valChange = kpis.valuation_change;
    const netSpend = kpis.net_spend;
    const ageDiff = (kpis.avg_age_after - kpis.avg_age_before).toFixed(1);
    // Younger squad after = positive (green), older = negative (red), unchanged = neutral
    const ageCls = ageDiff < 0 ? 'positive' : ageDiff > 0 ? 'negative' : 'neutral';

    const cards = [
      {
        label: 'Valuation Change',
        value: (valChange >= 0 ? '+' : '') + fmt(valChange),
        cls: valChange >= 0 ? 'positive' : 'negative',
        sub: `${fmt(kpis.total_valuation_before)} → ${fmt(kpis.total_valuation_after)}`,
      },
      {
        label: 'Net Spend',
        value: fmt(netSpend),
        cls: netSpend > 0 ? 'negative' : 'positive',
        sub: 'Transfer fees paid minus received',
      },
      {
        label: 'Avg Age Shift',
        value: (ageDiff > 0 ? '+' : '') + ageDiff + ' yrs',
        cls: ageCls,
        sub: `${kpis.avg_age_before} → ${kpis.avg_age_after} years`,
      },
      {
        label: 'Window Activity',
        value: `${sold_count} out · ${bought_count} in`,
        cls: 'neutral',
        sub: 'Players sold and bought',
      },
      {
        label: 'Budget Remaining',
        value: fmt(kpis.transfer_budget_remaining),
        cls: 'positive',
        sub: 'Transfer budget left unspent',
      },
      {
        label: 'Salary Committed',
        value: fmt(kpis.salary_used),
        cls: 'neutral',
        sub: `of ${fmt(kpis.salary_budget)} total budget`,
      },
      {
        label: 'Salary Available',
        value: fmt(kpis.salary_budget_remaining),
        cls: kpis.salary_budget_remaining > 0 ? 'positive' : 'negative',
        sub: 'Annual salary budget remaining',
      },
      {
        label: 'Squad Size',
        value: `${kpis.total_valuation_before > 0 ? '→' : ''} ${fmt(kpis.total_valuation_after)}`,
        cls: 'neutral',
        sub: 'Final squad total value',
      },
    ];

    row.innerHTML = cards.map(c => `
      <div class="kpi-card">
        <div class="kpi-label">${c.label}</div>
        <div class="kpi-value ${c.cls}">${c.value}</div>
        <div class="kpi-sub">${c.sub}</div>
      </div>`).join('');
  }

  const CHART_GRID = { color: 'rgba(48,54,61,0.8)' };
  const CHART_TICKS = { color: '#8b949e', font: { size: 12 } };

  function renderCharts(chart_data) {
    if (chartAge) chartAge.destroy();
    if (chartVal) chartVal.destroy();
    if (chartBudgetTransfer) chartBudgetTransfer.destroy();
    if (chartBudgetSalary) chartBudgetSalary.destroy();

    const ad = chart_data.age_distribution;

    // 1. Age distribution — full-width grouped bar
    chartAge = new Chart(document.getElementById('chart-age'), {
      type: 'bar',
      data: {
        labels: ad.labels,
        datasets: [
          {
            label: 'Before Transfer Window',
            data: ad.before,
            backgroundColor: 'rgba(56,139,253,0.5)',
            borderColor: '#388bfd',
            borderWidth: 1.5,
            borderRadius: 4,
          },
          {
            label: 'After Transfer Window',
            data: ad.after,
            backgroundColor: 'rgba(63,185,80,0.5)',
            borderColor: '#3fb950',
            borderWidth: 1.5,
            borderRadius: 4,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#8b949e', font: { size: 12 }, padding: 20, boxWidth: 14 },
          },
          tooltip: {
            callbacks: {
              label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y} players`,
            },
          },
        },
        scales: {
          x: { ticks: CHART_TICKS, grid: CHART_GRID },
          y: {
            ticks: { ...CHART_TICKS, stepSize: 1 },
            grid: CHART_GRID,
            title: { display: true, text: 'Players', color: '#8b949e', font: { size: 11 } },
          },
        },
      },
    });

    // 2. Valuation — vertical bar with value labels
    const v = chart_data.valuation;
    chartVal = new Chart(document.getElementById('chart-val'), {
      type: 'bar',
      data: {
        labels: ['Before', 'After'],
        datasets: [{
          data: [v.before / 1e6, v.after / 1e6],
          backgroundColor: ['rgba(56,139,253,0.5)', 'rgba(63,185,80,0.5)'],
          borderColor: ['#388bfd', '#3fb950'],
          borderWidth: 1.5,
          borderRadius: 5,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 1.4,
        layout: {
          padding: { top: 8, bottom: 8, left: 5, right: 5 },
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ` €${ctx.parsed.y.toFixed(1)}M` } },
        },
        scales: {
          x: { ticks: CHART_TICKS, grid: CHART_GRID },
          y: {
            ticks: {
              ...CHART_TICKS,
              callback: val => '€' + val + 'M',
              maxTicksLimit: 6,
            },
            grid: CHART_GRID,
          },
        },
      },
    });

    // 3. Budget — two horizontal stacked bars (transfer + salary, independent)
    const b = chart_data.budget;

    const makeBudgetBar = (label, spentVal, remainVal, spentColor, remainColor) => ({
      type: 'bar',
      data: {
        labels: [label],
        datasets: [
          {
            label: 'Spent / Used',
            data: [spentVal / 1e6],
            backgroundColor: spentColor,
            borderRadius: { topLeft: 4, bottomLeft: 4 },
            borderSkipped: false,
          },
          {
            label: 'Remaining',
            data: [remainVal / 1e6],
            backgroundColor: remainColor,
            borderRadius: { topRight: 4, bottomRight: 4 },
            borderSkipped: false,
          },
        ],
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 4,
        layout: {
          padding: { left: 0, right: 5, top: 8, bottom: 8 },
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#c9d1d9', font: { size: 12 }, padding: 14, boxWidth: 11, boxHeight: 11 },
          },
          tooltip: {
            callbacks: {
              label: ctx => ` ${ctx.dataset.label}: €${ctx.parsed.x.toFixed(1)}M`,
            },
          },
        },
        scales: {
          x: {
            stacked: true,
            ticks: {
              color: '#c9d1d9',
              font: { size: 12 },
              callback: v => '€' + v + 'M',
              maxTicksLimit: 4,
              maxRotation: 0,
              autoSkip: true,
            },
            grid: CHART_GRID,
          },
          y: {
            stacked: true,
            ticks: { color: '#c9d1d9', font: { size: 12 }, crossAlign: 'far' },
            grid: { display: false },
          },
        },
      },
    });

    chartBudgetTransfer = new Chart(
      document.getElementById('chart-budget-transfer'),
      makeBudgetBar('Transfer Budget', b.transfer_spent, b.transfer_remaining,
        'rgba(218,54,51,0.75)', 'rgba(35,134,54,0.6)')
    );
    chartBudgetSalary = new Chart(
      document.getElementById('chart-budget-salary'),
      makeBudgetBar('Salary Budget', b.salary_used, b.salary_remaining,
        'rgba(210,153,34,0.75)', 'rgba(56,139,253,0.6)')
    );
  }

  function renderAnalysis(analysis, players_sold, players_bought) {
    document.getElementById('obs-list').innerHTML =
      analysis.key_observations.map(o => `<li>${o}</li>`).join('');

    document.getElementById('financial-verdict').textContent = analysis.financial_verdict;
    document.getElementById('weakness-text').textContent = analysis.weakness;

    // Build justification lookup
    const soldMap = {}, boughtMap = {};
    for (const j of analysis.transfer_justifications) {
      if (j.decision === 'sold') soldMap[j.player_name] = j;
      else boughtMap[j.player_name] = j;
    }

    function playerCard(p, justMap) {
      const j = justMap[p.name] || {};
      const mv = p.market_value ? fmt(p.market_value) : 'N/A';
      return `<div class="transfer-item">
        <div class="t-header">
          <div class="t-name">${p.name}</div>
          <div class="t-fee">${mv}</div>
        </div>
        <div class="t-meta">Age ${p.age || '?'} · ${p.position || 'Unknown'}</div>
        <div class="t-reason">${j.reasoning || ''}</div>
      </div>`;
    }

    const soldHtml = players_sold.map(p => playerCard(p, soldMap)).join('');
    const boughtHtml = players_bought.map(p => playerCard(p, boughtMap)).join('');

    document.getElementById('sold-count').textContent = players_sold.length;
    document.getElementById('bought-count').textContent = players_bought.length;
    document.getElementById('sold-list').innerHTML = soldHtml || '<p style="color:var(--muted);font-size:13px;padding:8px 0">No players sold</p>';
    document.getElementById('bought-list').innerHTML = boughtHtml || '<p style="color:var(--muted);font-size:13px;padding:8px 0">No players bought</p>';
  }

  // ── Form submit ──
  document.getElementById('sim-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = document.getElementById('run-btn');
    const status = document.getElementById('status-msg');
    const errBanner = document.getElementById('error-banner');
    const results = document.getElementById('results');

    btn.classList.add('loading');
    btn.disabled = true;
    btn.querySelector('.btn-text').textContent = 'Simulating...';
    status.textContent = 'Running engine + AI analysis — this takes 15-30s';
    errBanner.style.display = 'none';
    results.style.display = 'none';

    const mode = document.getElementById('strategy_mode').value;
    const payload = {
      team_name: document.getElementById('team_name').value,
      season: parseInt(document.getElementById('season').value),
      transfer_budget: parseInt(document.getElementById('transfer_budget').value),
      salary_budget: parseInt(document.getElementById('salary_budget').value),
      strategy_mode: mode,
    };

    try {
      const res = await fetch('/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || `HTTP ${res.status}`);
      }

      const data = await res.json();

      // Headline
      const modeLabel = MODE_LABELS[data.strategy_mode] || data.strategy_mode;
      document.getElementById('headline-meta').innerHTML =
        `${data.club} &nbsp;·&nbsp; ${data.season} &nbsp;·&nbsp; <span class="mode-badge ${data.strategy_mode}">${modeLabel} Strategy</span>`;
      document.getElementById('headline-text').textContent = data.analysis.headline;

      renderKPIs(data.kpis, data.players_sold.length, data.players_bought.length);
      renderCharts(data.chart_data);
      renderAnalysis(data.analysis, data.players_sold, data.players_bought);

      results.style.display = 'block';
      results.scrollIntoView({ behavior: 'smooth', block: 'start' });
      status.textContent = '';
    } catch (err) {
      errBanner.textContent = '⚠ ' + err.message;
      errBanner.style.display = 'block';
      status.textContent = '';
    } finally {
      btn.classList.remove('loading');
      btn.disabled = false;
      btn.querySelector('.btn-text').textContent = 'Run Simulation';
    }
  });
</script>
</body>
</html>
